// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  phone     String?
  password  String?  // Optional for OAuth users
  avatar    String?
  role      UserRole @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // OAuth fields
  googleId     String? @unique
  authProvider String? // 'google', 'local', etc.

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Referral program
  referralCode    String  @unique @default(uuid())
  referredBy      String? // User ID who referred this user
  referralRewards Float   @default(0)
  totalReferrals  Int     @default(0)

  // First booking incentive
  hasCompletedFirstBooking Boolean @default(false)
  firstBookingDiscountUsed Boolean @default(false)

  // Data protection consent (Ghana Act 843 compliance)
  consentPrivacy     Boolean   @default(false)
  consentTerms        Boolean   @default(false)
  consentMarketing    Boolean   @default(false)
  consentPrivacyAt    DateTime?
  consentTermsAt      DateTime?
  consentMarketingAt  DateTime?

  bookings      Booking[]
  reviews       Review[]
  subscriptions Subscription[]
  referrals     Referral[]     @relation("Referrer")
  referred      Referral[]     @relation("Referee")
  provider      Provider?
  settings      UserSettings?
  customerChats Chat[]          @relation("CustomerChats")
  providerChats Chat[]          @relation("ProviderChats")
  sentMessages  Message[]       @relation("SentMessages")
  receivedMessages Message[]    @relation("ReceivedMessages")

  @@map("users")
}

model Provider {
  id             String          @id @default(cuid())
  userId         String          @unique
  name           String
  category       ServiceCategory
  location       String
  description    String
  phone          String?
  whatsapp       String?
  verified       Boolean         @default(false)
  rating         Float           @default(0)
  reviewCount    Int             @default(0)
  completionRate Float?
  availability   Availability    @default(AVAILABLE_SOON)
  image          String?
  avatar         String?
  serviceAreas   String[]
  skills         String[]
  joinedDate     DateTime        @default(now())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Enhanced verification fields
  idDocumentUrl      String? // ID card/passport upload
  references         String[] // Reference contacts
  workPhotos         String[] // Portfolio photos
  workVideos         String[] // Portfolio videos
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?

  // Monetization
  isPremium        Boolean          @default(false)
  premiumExpiresAt DateTime?
  subscriptionTier SubscriptionTier @default(FREE)

  // Business tools
  taxId               String?
  bankAccount         String?
  mobileMoneyNumber   String?
  mobileMoneyProvider MobileMoneyProvider?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings Booking[]
  reviews  Review[]
  services Service[]
  payouts  Payout[]
  availabilitySlots AvailabilitySlot[]

  @@index([category])
  @@index([location])
  @@index([verified])
  @@index([rating])
  @@index([availability])
  @@index([category, location])
  @@index([verified, rating])
  @@map("providers")
}

model Booking {
  id          String        @id @default(cuid())
  providerId  String
  userId      String
  date        DateTime
  time        String
  serviceType String
  notes       String?
  status      BookingStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Enhanced tracking
  amount           Float?
  paymentStatus    PaymentStatus  @default(PENDING)
  paymentMethod    PaymentMethod?
  commissionRate   Float? // Platform commission percentage
  commissionAmount Float?

  // Tracking & satisfaction
  estimatedDuration    Int? // in minutes
  actualStartTime      DateTime?
  actualEndTime        DateTime?
  customerSatisfaction Int? // 1-5 rating

  // Referral tracking
  referredBy     String? // User ID who referred
  referralReward Float?

  // First booking incentive
  isFirstBooking       Boolean @default(false)
  firstBookingDiscount Float?

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment  Payment?
  reviews  Review[] // Reviews for this booking

  @@index([providerId])
  @@index([userId])
  @@index([status])
  @@index([date])
  @@index([userId, status])
  @@index([providerId, status])
  @@map("bookings")
}

model Review {
  id                 String    @id @default(cuid())
  providerId         String
  userId             String
  bookingId          String? // Link to completed booking for verification
  rating             Int
  comment            String
  photos             String[] // URLs of work photos
  providerResponse   String? // Provider's response to review
  providerResponseAt DateTime?
  isVerified         Boolean   @default(false) // Verified post-job review
  verifiedAt         DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking  Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([providerId])
  @@index([userId])
  @@index([isVerified])
  @@index([rating])
  @@index([providerId, rating])
  @@map("reviews")
}

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum ServiceCategory {
  Electrician
  Plumber
  Cleaner
  Handyman
  Carpenter
  Painter
  Mechanic
  Gardener
  Tiler
  Welder
  EmergencyService
  NetworkSetup
  VeterinaryCare
  Pharmacy
  Other
}

enum Availability {
  AVAILABLE_NOW
  AVAILABLE_SOON
  NOT_AVAILABLE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model Service {
  id                   String          @id @default(cuid())
  providerId           String
  name                 String
  description          String
  category             ServiceCategory
  pricingModel         PricingModel    @default(PAY_AS_YOU_GO)
  basePrice            Float // For pay-as-you-go: price per service. For subscription: setup fee
  duration             Int // Duration in minutes
  isActive             Boolean         @default(true)
  image                String?
  // Subscription-specific fields
  monthlyPrice         Float? // Monthly subscription price
  billingCycle         BillingCycle? // Billing frequency
  subscriptionFeatures String[] // Features included in subscription
  visitsPerPeriod      Int? // Number of visits included per billing cycle (null = unlimited)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  provider      Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@map("services")
}

enum PricingModel {
  PAY_AS_YOU_GO
  SUBSCRIPTION
}

enum BillingCycle {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum VerificationStatus {
  PENDING
  IN_REVIEW
  VERIFIED
  REJECTED
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  MOBILE_MONEY_MTN
  MOBILE_MONEY_VODAFONE
  MOBILE_MONEY_AIRTELTIGO
  BANK_TRANSFER
  CASH
  WALLET
}

enum MobileMoneyProvider {
  MTN
  VODAFONE
  AIRTELTIGO
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PayoutMethod {
  MOBILE_MONEY_MTN
  MOBILE_MONEY_VODAFONE
  MOBILE_MONEY_AIRTELTIGO
  BANK_TRANSFER
}

enum ReferralStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model Subscription {
  id              String             @id @default(cuid())
  userId          String
  serviceId       String
  providerId      String
  status          SubscriptionStatus @default(ACTIVE)
  startDate       DateTime           @default(now())
  nextBillingDate DateTime
  lastBillingDate DateTime?
  visitsUsed      Int                @default(0)
  visitsRemaining Int? // null = unlimited
  autoRenew       Boolean            @default(true)
  cancelledAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// Payment model
model Payment {
  id                  String               @id @default(cuid())
  bookingId           String               @unique
  amount              Float
  status              PaymentStatus        @default(PENDING)
  method              PaymentMethod
  transactionId       String?
  mobileMoneyNumber   String?
  mobileMoneyProvider MobileMoneyProvider?
  bankAccount         String?
  paidAt              DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Payout model for providers
model Payout {
  id                  String               @id @default(cuid())
  providerId          String
  amount              Float
  status              PayoutStatus         @default(PENDING)
  method              PayoutMethod
  transactionId       String?
  mobileMoneyNumber   String?
  mobileMoneyProvider MobileMoneyProvider?
  bankAccount         String?
  processedAt         DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("payouts")
}

// Referral tracking
model Referral {
  id           String         @id @default(cuid())
  referrerId   String // User who made the referral
  refereeId    String // User who was referred
  rewardAmount Float          @default(0)
  status       ReferralStatus @default(PENDING)
  completedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  referrer User @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  User @relation("Referee", fields: [refereeId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

// Analytics and insights
model Analytics {
  id         String   @id @default(cuid())
  providerId String?
  userId     String?
  eventType  String // 'booking_created', 'booking_completed', 'search', etc.
  eventData  Json // Flexible JSON data
  metadata   Json?
  createdAt  DateTime @default(now())

  @@map("analytics")
}

// User Settings model
model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  // Notification preferences
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  pushNotifications  Boolean  @default(true)
  bookingReminders   Boolean  @default(true)
  promotions         Boolean  @default(false)
  // Privacy settings
  profileVisibility  String   @default("public") // "public" | "private"
  showEmail          Boolean  @default(false)
  showPhone          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// Provider availability slots for calendar integration
model AvailabilitySlot {
  id          String   @id @default(cuid())
  providerId  String
  date        DateTime // Date only (time will be 00:00:00)
  startTime   String   // "09:00" format
  endTime     String   // "17:00" format
  isAvailable Boolean  @default(true)
  isRecurring Boolean  @default(false)
  recurringPattern String? // "daily", "weekly", "weekdays", "weekends"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, date, startTime])
  @@index([providerId, date])
  @@index([providerId, isAvailable])
  @@map("availability_slots")
}

// Real-time Chat System
model Chat {
  id          String   @id @default(cuid())
  customerId  String
  providerId  String
  bookingId   String?  // Optional link to booking
  lastMessage String?
  lastMessageAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer User @relation("CustomerChats", fields: [customerId], references: [id], onDelete: Cascade)
  provider User @relation("ProviderChats", fields: [providerId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([customerId, providerId])
  @@index([customerId])
  @@index([providerId])
  @@index([bookingId])
  @@map("chats")
}

model Message {
  id          String   @id @default(cuid())
  chatId      String
  senderId    String   // User ID
  receiverId  String   // User ID
  content     String
  messageType String   @default("text") // "text", "image", "file"
  fileUrl     String?
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId, receiverId])
  @@index([isRead])
  @@map("messages")
}
